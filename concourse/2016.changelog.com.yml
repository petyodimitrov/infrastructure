resources:
  - name: infrastructure
    type: git
    source:
      uri: git@github.com:thechangelog/infrastructure.git
      branch: master
      private_key: {{concourse_ssh_private_key}}

  - name: dotcom
    type: git
    source:
      uri: git@github.com:thechangelog/dotcom.git
      branch: master
      private_key: {{concourse_ssh_private_key}}

  - name: daily
    type: time
    source:
      interval: 24h

jobs:
  - name: configure
    serial_groups:
      - backup
    plan:
      - aggregate:
        - get: infrastructure
          trigger: true
        - get: daily
          trigger: true
      - task: default
        file: infrastructure/concourse/play.yml
        params:
          ANSIBLE_PLAYBOOK: default.yml
          CONCOURSE_SSH_PRIVATE_KEY: {{concourse_ssh_private_key}}
          SSH_KNOWN_HOSTS: {{ssh_known_hosts}}
          AUTHORIZED_KEYS: {{authorized_keys}}
          HTTPS_CERT: {{changelog_https_cert}}
          HTTPS_KEY: {{changelog_https_key}}
          HTTPS_CHAIN: {{changelog_https_chain}}
          DNSIMPLE_EMAIL: {{dnsimple_email}}
          DNSIMPLE_API_TOKEN: {{dnsimple_api_token}}
          PG_DOTCOM_PASS: {{postgres_admin_pass}}
          PG_CONCOURSE_PASS: {{postgres_concourse_pass}}
      - task: concourse
        file: infrastructure/concourse/play.yml
        params:
          ANSIBLE_PLAYBOOK: concourse.yml
          CONCOURSE_SSH_PRIVATE_KEY: {{concourse_ssh_private_key}}
          CONCOURSE_AUTH_PASS: {{concourse_auth_pass}}
          SSH_KNOWN_HOSTS: {{ssh_known_hosts}}
          PG_DOTCOM_PASS: {{postgres_admin_pass}}
      - task: dotcom
        file: infrastructure/concourse/play.yml
        params:
          ANSIBLE_PLAYBOOK: dotcom.yml
          CONCOURSE_SSH_PRIVATE_KEY: {{concourse_ssh_private_key}}
          SSH_KNOWN_HOSTS: {{ssh_known_hosts}}
          PG_DOTCOM_PASS: {{postgres_admin_pass}}

  - name: backup
    serial_groups:
      - backup
    plan:
      - get: infrastructure
      - get: daily
        trigger: true
      - task: dotcom
        file: infrastructure/concourse/play.yml
        params:
          ANSIBLE_PLAYBOOK: dotcom.yml -t dotcom_backup -e dotcom_backup=true
          CONCOURSE_SSH_PRIVATE_KEY: {{concourse_ssh_private_key}}
          SSH_KNOWN_HOSTS: {{ssh_known_hosts}}
          DOTCOM_BACKUP_AWS_REGION: {{dotcom_backup_aws_region}}
          DOTCOM_BACKUP_S3_BUCKET: {{dotcom_backup_s3_bucket}}
          DOTCOM_BACKUP_AWS_ACCESS_KEY_ID: {{dotcom_backup_aws_access_key_id}}
          DOTCOM_BACKUP_AWS_SECRET_ACCESS_KEY: {{dotcom_backup_aws_secret_access_key}}
          PG_DOTCOM_PASS: {{postgres_admin_pass}}

  - name: deploy
    serial_groups:
      - backup
    plan:
      - aggregate:
        - get: infrastructure
        - get: dotcom
          trigger: true
        - get: daily
          trigger: true
      - task: deploy dotcom
        file: infrastructure/concourse/play.yml
        params:
          ANSIBLE_PLAYBOOK: dotcom.yml
          CONCOURSE_SSH_PRIVATE_KEY: {{concourse_ssh_private_key}}
          SSH_KNOWN_HOSTS: {{ssh_known_hosts}}
          DOTCOM_BACKUP_AWS_REGION: {{dotcom_backup_aws_region}}
          DOTCOM_BACKUP_S3_BUCKET: {{dotcom_backup_s3_bucket}}
          DOTCOM_BACKUP_AWS_ACCESS_KEY_ID: {{dotcom_backup_aws_access_key_id}}
          DOTCOM_BACKUP_AWS_SECRET_ACCESS_KEY: {{dotcom_backup_aws_secret_access_key}}
          PG_DOTCOM_PASS: {{postgres_admin_pass}}
          CM_TOKEN: {{campaign_monitor_token}}
